#!/bin/sh

[ -f /etc/sysconfig/clamd ] && . /etc/sysconfig/clamd

[ -z "$UPDATE_HOUR" ] && UPDATE_HOUR=2
DIV="$(echo "$(LC_ALL=C date "+%H % ${UPDATE_HOUR}")" | bc)"
[ "$DIV" = "0" ] || exit 0

# sleep random amount to avoid all servers hitting clamav servers at same time
# but at most 1800 seconds (half hour)
rand=${RANDOM:-$$}
rand="$(echo "$rand % 1800" | bc)"
sleep $rand

[ -z "$UPDATE_MAIL_MESSAGES" ] && UPDATE_MAIL_MESSAGES="errors"
[ "$UPDATE_MAIL_MESSAGES" = "errors" ] && freshclamopt="--quiet"

notify=
[ -f /var/lock/subsys/clamd ] && notify="--daemon-notify"

umask 022
log=$(/usr/bin/freshclam $freshclamopt $notify 2>&1)
[ "$UPDATE_MAIL_MESSAGES" != "none" -a -n "$log" ] && echo "$log"
